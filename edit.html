<!DOCTYPE html>
<head>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
<link rel="stylesheet" type="text/css" href="https://handsontable.com/static/css/main.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.js"></script>

<!-- <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
-->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</head>


<body>


<button type="button" class="btn btn-primary size-medium bg-green text-white shadow hover-moveup" data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo">Create Pull Request</button>
<button id="export-csv" class="btn btn-primary" style="margin-left: 5px;">Download CSV</button>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">New message</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="form-elem">
          <div class="form-group">
            <label>Email</label>
          	<input for="email" value="user@email.com"></input>
          </div>
          <div class="form-group">
            <label>PR Tag</label>
          	<input for="pr_tag" value="pr-tag"></input>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" id="export-string-modal" class="btn btn-primary">Creat PR</button>
      </div>
    </div>
  </div>
</div>



<div id="hot"></div>

<script>

document.getElementById("export-csv").addEventListener("click", function(event) { document.hot.getPlugin("exportFile").downloadFile("csv", {filename: "Handsontable CSV Export example"});})
document.getElementById("export-string-modal").addEventListener("click", function(event) {
	// console.log("hi");
	var dat = document.getElementById('form-elem');
	var dict = {};
	for(i=0;i<dat.elements.length;i++){
		dict[dat.elements[i].attributes.for.value] = dat.elements[i].value;

	};
	var meta = dict;
	window.dict = dict;
	console.log(dict);

	var xhr = new XMLHttpRequest();
	xhr.open("POST", "/auto_pr/", true);
	xhr.setRequestHeader("Content-Type", "application/json")
	xhr.onreadystatechange = function() { 
	// Call a function when the state changes.
	    if (this.readyState === XMLHttpRequest.DONE){
	    	if (this.status===200){
		    	window.alert('Update successful!\nResponseText:'+this.responseText)
	    	}else{
		    	window.alert('Update failed!'+this)    		
	    	}
	    }
	}
	var data=document.hot.getData();
	xhr.send(JSON.stringify({
		"type":"csvBuffer",
		"data":data,
		"columns":document.hot.getColHeader(),
		"email":meta.email,
		"pr_tag":meta.pr_tag
	}));

	// xhr.send(JSON.stringify(document.hot.getData()));
})


// var hotElement = document.querySelector('#hot');
// var hotElementContainer = hotElement.parentNode;
// var hotSettings = {};
// var hot = new Handsontable(hotElement, hotSettings);

document.addEventListener('DOMContentLoaded', function() {

	var xhttp = new XMLHttpRequest();
	xhttp.open("GET", "current.csv", true);
	xhttp.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
		var dataBuffer = CSVToArray(this.responseText);

		document.dataBuffer = dataBuffer;
		var columns = dataBuffer[0];
		var hotSettings = {
		  data: dataBuffer.slice(1),
		  // dataObject,
		  colHeaders: columns,
		  columns: [...Array(columns.length).keys()].map(function(v){return ({data:v, width:(window.innerWidth-100)/columns.length})}),
		  stretchH: 'all',
		  width: 805,
		  autoWrapRow: true,
		  // height: "100%",
		  // maxRows: 22,
		  manualRowResize: true,
		  manualColumnResize: true,
		  rowHeaders: true,
		  // colHeaders: true,
		  manualRowMove: true,
		  manualColumnMove: true,
		  contextMenu: true,
		  filters: true,
		  dropdownMenu: true,
		  exportFile: true
		};    
		// container2 = document.getElementById('hot')
		document.hot = new Handsontable(
			document.getElementById('hot'),
			hotSettings);
	  	// console.log(this.responseText)
	    // document.getElementById("demo").innerHTML = this.responseText;
	  }else{
	  	console.log(this);
	  }
	};
	xhttp.send();

});


    // ref: http://stackoverflow.com/a/1293163/2343
    // This will parse a delimited string into an array of
    // arrays. The default delimiter is the comma, but this
    // can be overriden in the second argument.
    function CSVToArray( strData, strDelimiter ){
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = (strDelimiter || ",");

        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
            (
                // Delimiters.
                "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

                // Quoted fields.
                "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

                // Standard fields.
                "([^\"\\" + strDelimiter + "\\r\\n]*))"
            ),
            "gi"
            );


        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];

        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;


        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while (arrMatches = objPattern.exec( strData )){

            // Get the delimiter that was found.
            var strMatchedDelimiter = arrMatches[ 1 ];

            // Check to see if the given delimiter has a length
            // (is not the start of string) and if it matches
            // field delimiter. If id does not, then we know    // ref: http://stackoverflow.com/a/1293163/2343
    // This will parse a delimited string into an array of
    // arrays. The default delimiter is the comma, but this
    // can be overriden in the second argument.
    function CSVToArray( strData, strDelimiter ){
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = (strDelimiter || ",");

        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
            (
                // Delimiters.
                "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

                // Quoted fields.
                "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

                // Standard fields.
                "([^\"\\" + strDelimiter + "\\r\\n]*))"
            ),
            "gi"
            );


        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];

        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;


        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while (arrMatches = objPattern.exec( strData )){

            // Get the delimiter that was found.
            var strMatchedDelimiter = arrMatches[ 1 ];

            // Check to see if the given delimiter has a length
            // (is not the start of string) and if it matches
            // field delimiter. If id does not, then we know
            // that this delimiter is a row delimiter.
            if (
                strMatchedDelimiter.length &&
                strMatchedDelimiter !== strDelimiter
                ){

                // Since we have reached a new row of data,
                // add an empty row to our data array.
                arrData.push( [] );

            }

            var strMatchedValue;

            // Now that we have our delimiter out of the way,
            // let's check to see which kind of value we
            // captured (quoted or unquoted).
            if (arrMatches[ 2 ]){

                // We found a quoted value. When we capture
                // this value, unescape any double quotes.
                strMatchedValue = arrMatches[ 2 ].replace(
                    new RegExp( "\"\"", "g" ),
                    "\""
                    );

            } else {

                // We found a non-quoted value.
                strMatchedValue = arrMatches[ 3 ];

            }


            // Now that we have our value string, let's add
            // it to the data array.
            arrData[ arrData.length - 1 ].push( strMatchedValue );
        }

        // Return the parsed data.
        return( arrData );
    }
            // that this delimiter is a row delimiter.
            if (
                strMatchedDelimiter.length &&
                strMatchedDelimiter !== strDelimiter
                ){

                // Since we have reached a new row of data,
                // add an empty row to our data array.
                arrData.push( [] );

            }

            var strMatchedValue;

            // Now that we have our delimiter out of the way,
            // let's check to see which kind of value we
            // captured (quoted or unquoted).
            if (arrMatches[ 2 ]){

                // We found a quoted value. When we capture
                // this value, unescape any double quotes.
                strMatchedValue = arrMatches[ 2 ].replace(
                    new RegExp( "\"\"", "g" ),
                    "\""
                    );

            } else {

                // We found a non-quoted value.
                strMatchedValue = arrMatches[ 3 ];

            }


            // Now that we have our value string, let's add
            // it to the data array.
            arrData[ arrData.length - 1 ].push( strMatchedValue );
        }

        // Return the parsed data.
        return( arrData );
    }
</script>

</body>
</html>